name: Sync ITV Playlist

on:
  schedule:
    - cron: '0 */12 * * *'  # æ¯12å°æ—¶è¿è¡Œä¸€æ¬¡ï¼ˆUTCæ—¶é—´ï¼‰
  workflow_dispatch:
    åˆ†æ”¯:
      - main
jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ä¸‹è½½æ’­æ”¾åˆ—è¡¨
        id: download
        run: |
          # æ·»åŠ é‡è¯•æœºåˆ¶å’Œé”™è¯¯å¤„ç†
          if ! curl -s -f -o temp.m3u https://raw.bgithub.xyz/sln654360/itv/refs/heads/main/itv.m3u; then
            echo "::error:: æ— æ³•ä¸‹è½½æ’­æ”¾åˆ—è¡¨"
            exit 1
          fi
          echo "æ–‡ä»¶å¤§å°: $(wc -c < temp.m3u) å­—èŠ‚"

      - name: æ ¡éªŒå¹¶æ›´æ–°
        id: update
        run: |
          # å¤„ç†é¦–æ¬¡è¿è¡Œæ— æ–‡ä»¶æƒ…å†µ
          if [ ! -f itv.m3u ]; then
            echo "æ£€æµ‹åˆ°é¦–æ¬¡è¿è¡Œï¼Œåˆ›å»ºæ–°æ–‡ä»¶"
            mv -v temp.m3u itv.m3u
            echo "has_changes=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # æ¯”è¾ƒæ–‡ä»¶å·®å¼‚
          if cmp -s itv.m3u temp.m3u; then
            echo "æ–‡ä»¶å†…å®¹ç›¸åŒ"
            rm temp.m3u
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "æ£€æµ‹åˆ°å†…å®¹å˜åŒ–"
            mv -f temp.m3u itv.m3u
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: è°ƒè¯•ä¿¡æ¯
        if: always()
        run: |
          echo "å½“å‰ç›®å½•æ–‡ä»¶åˆ—è¡¨:"
          ls -lh
          echo "itv.m3u æ˜¯å¦å­˜åœ¨: [$(test -f itv.m3u && echo 'æ˜¯' || echo 'å¦')]"

      - name: æäº¤æ›´æ”¹
        if: steps.update.outputs.has_changes == 'true'
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add itv.m3u
          
          # æ·»åŠ æäº¤å‰æ ¡éªŒ
          if [ ! -f itv.m3u ]; then
            echo "::error:: ç›®æ ‡æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•æäº¤"
            exit 1
          fi
          
          git commit -m "ğŸ”„ è‡ªåŠ¨åŒæ­¥æ’­æ”¾åˆ—è¡¨ [$(date +'%Y-%m-%d %H:%M UTC')]" 
          git push
